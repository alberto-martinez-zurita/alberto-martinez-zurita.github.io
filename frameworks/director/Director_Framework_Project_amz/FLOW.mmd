graph TD
    %% --- INICIO ---
    Start((INICIO)) --> F0[FASE 0 WARM UP]
    
    %% FASE 0
    F0 -->|In: 1 RAG Dir, 2 Prompt Dir| Agente[Agente Instruido]

    %% --- FASE 1: IDEATION ---
    Agente --> F1_Factory[F1 GENERAR PROMPT]
    F1_Factory -->|In: 3 Plantilla, 4.1 Idea, 4.2 Contexto| Prompt5[Prompt 5 Generado]
    
    Prompt5 --> F1_Exec[F1 EJECUTAR]
    F1_Exec -->|In: 5 Prompt, 4.1, 4.2| Ent6_7[Entregables 6 Obj + 7 Pitch]

    %% --- FASE 2: REQUISITOS ---
    Ent6_7 --> Gate1{Validar Coherencia}
    Gate1 -- No --> F1_Factory
    Gate1 -- Si --> F2_Factory[F2 GENERAR PROMPT]

    F2_Factory -->|In: 8 Template+RAG CLAR, 6, 7| Prompt9[Prompt 9 Generado]
    
    Prompt9 --> F2_Exec[F2 EJECUTAR]
    F2_Exec -->|In: 9 Prompt, 6, 7, 8 RAG| Ent10[Entregable 10 Requisitos]

    %% --- FASE 3: ARQUITECTURA ---
    Ent10 --> Gate2{Validar KPI CLAR}
    Gate2 -- No --> F2_Factory
    Gate2 -- Si --> F3_Factory[F3 GENERAR PROMPT]

    F3_Factory -->|In: 11 Template, 10, 6, 12 RAG TEC| Prompt13[Prompt 13 Generado]

    Prompt13 --> F3_Exec[F3 EJECUTAR]
    F3_Exec -->|In: 13 Prompt, 10, 12 RAG TEC, RAG ERR| Ent14[Entregable 14 ADR + Mermaid]

    %% --- FASE 4: PLAN ---
    Ent14 --> Gate3{Validar KPI CLAR}
    Gate3 -- No --> F3_Factory
    Gate3 -- Si --> F4_Exec[F4 PLANIFICAR]

    F4_Exec -->|In: 10 Reqs, 14 Arq| Ent15[Entregable 15 Master Plan]

    %% --- FASE 5: DESARROLLO (TDD) ---
    Ent15 --> F5_Split[F5 DESGLOSE TAREAS]
    F5_Split -->|In: 15 Plan, 14 Arq, 17 Template Dev| PromptsDev[Prompts Tareas N]

    PromptsDev --> LoopTDD((BUCLE TDD))
    
    LoopTDD -->|Paso A: Generar Test| CodeTest[Codigo Test]
    CodeTest -->|Paso B: Generar Codigo| CodeSource[Codigo Fuente]
    
    CodeSource --> CheckTest{Tests OK?}
    CheckTest -- No Max 10 --> LoopTDD
    CheckTest -- Si --> Ent16[Entregable 16 Verificado]

    %% --- FASE 6 & CIERRE ---
    Ent16 --> F6_Valid[F6 VALIDACION SOFT]
    F6_Valid -->|In: 16 Code, 8 RAG CLAR| Report[Reporte Calidad]

    Report --> GateFinal{Aprobado?}
    GateFinal -- No Critico --> F3_Factory
    GateFinal -- No Leve --> LoopTDD
    GateFinal -- Si --> F7_Close[F7 CIERRE Y APRENDIZAJE]

    F7_Close -->|Update| RAGs[Actualizar RAGs 8, 12, ERR]
    RAGs --> Fin((FIN))